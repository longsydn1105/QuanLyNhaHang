<!DOCTYPE html>
<html lang="vi">
<head>
	<meta charset="UTF-8" />
	<title>Danh s√°ch b√†n</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-6">
	<header class="flex justify-between items-center mb-6">
		<h1 class="text-2xl font-bold text-gray-800">üçΩÔ∏è Danh s√°ch b√†n</h1>
		<button onclick="addNewTable()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
			‚ûï Th√™m b√†n m·ªõi
		</button>
	</header>

	<div id="addRow" class="bg-yellow-50 p-4 rounded-xl shadow flex flex-col md:flex-row items-center gap-4 mb-6 hidden">
		<input id="newName" placeholder="T√™n b√†n" class="border rounded px-3 py-2 w-full md:w-1/4" />
		<select id="newStatus" class="border rounded px-3 py-2 w-full md:w-1/4">
			<option value="available">Tr·ªëng</option>
			<option value="occupied">ƒêang s·ª≠ d·ª•ng</option>
		</select>
		<div class="flex gap-2">
			<button onclick="confirmAddTable()" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700">X√°c nh·∫≠n</button>
			<button onclick="cancelAddTable()" class="bg-gray-400 text-white px-3 py-2 rounded hover:bg-gray-500">Hu·ª∑</button>
		</div>
	</div>

	<div id="tableList" class="space-y-4"></div>

	<script>
	const token = localStorage.getItem("token");
	if (!token) {
		alert("Vui l√≤ng ƒëƒÉng nh·∫≠p");
		window.location.href = "/login";
	}

	const headers = {
		"Authorization": "Bearer " + token,
		"Content-Type": "application/json"
	};

	async function fetchTables() {
		try {
			const res = await fetch("/api/tables", { headers });
			const data = await res.json();
			renderTables(data);
		} catch (err) {
			alert("L·ªói khi t·∫£i danh s√°ch b√†n!");
			console.error(err);
		}
	}

	async function fetchBillInfo(billId) {
		if (!billId) return "";
		try {
			const res = await fetch(`/api/bills/${billId}`, { headers });
			const data = await res.json();
			const items = data.items.map(i => `${i.name} (${i.quantity})`).join(", ");
			const total = data.items.reduce((sum, i) => sum + (i.price * i.quantity), 0);
			return `<p class='text-sm text-gray-600'>M√≥n: ${items}</p><p class='text-sm text-gray-800 font-semibold'>T·ªïng: ${total.toLocaleString()}ƒë</p>`;
		} catch (err) {
			console.error(err);
			return "<p class='text-sm text-red-600'>Kh√¥ng l·∫•y ƒë∆∞·ª£c ho√° ƒë∆°n</p>";
		}
	}

	async function renderTables(tables) {
		try {
			const container = document.getElementById("tableList");
			container.innerHTML = "";
			for (const table of tables) {
				const row = document.createElement("div");
				row.className = "bg-white p-4 rounded-xl shadow flex flex-col md:flex-row items-center gap-4";

				const billInfoHTML = table.currentBillID ? await fetchBillInfo(table.currentBillID) : "<p class='text-sm text-gray-500'>Ch∆∞a c√≥ bill</p>";

				row.innerHTML = `
					<input class="border rounded px-3 py-2 w-full md:w-1/4" value="${table.name}" id="name-${table._id}" readonly />
					<select class="border rounded px-3 py-2 w-full md:w-1/4" id="status-${table._id}">
						<option value="available" ${table.status === "available" ? "selected" : ""}>Tr·ªëng</option>
						<option value="occupied" ${table.status === "occupied" ? "selected" : ""}>S·ª≠ d·ª•ng</option>
					</select>
					<div class="md:flex-1">${billInfoHTML}</div>
					<div class="flex gap-2">
						<button onclick="updateTable('${table._id}')" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">L∆∞u</button>
						<button onclick="deleteTable('${table._id}')" class="bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700">Xo√°</button>
					</div>
				`;
				container.appendChild(row);
			}
		} catch (err) {
			console.error("L·ªói khi hi·ªÉn th·ªã danh s√°ch b√†n:", err);
		}
	}

	async function updateTable(id) {
		try {
			const resCheck = await fetch(`/api/tables/${id}`, { headers });
			const table = await resCheck.json();

			if (table.currentBillID) {
				alert("Kh√¥ng th·ªÉ ƒë·ªïi tr·∫°ng th√°i v√¨ b√†n ƒëang c√≥ bill!");
				return;
			}

			const name = document.getElementById(`name-${id}`).value;
			const status = document.getElementById(`status-${id}`).value;

			const res = await fetch(`/api/tables/${id}/status`, {
				method: "PATCH",
				headers,
				body: JSON.stringify({ name, status })
			});

			const data = await res.json();
			alert(data.message || "ƒê√£ c·∫≠p nh·∫≠t!");
			fetchTables();
		} catch (err) {
			alert("L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i b√†n!");
			console.error(err);
		}
	}

	async function deleteTable(id) {
		if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° b√†n n√†y?")) return;

		try {
			const resCheck = await fetch(`/api/tables/${id}`, { headers });
			const table = await resCheck.json();

			if (table.currentBillID) {
				alert("Kh√¥ng th·ªÉ xo√° b√†n ƒëang c√≥ bill!");
				return;
			}

			const res = await fetch(`/api/tables/${id}`, {
				method: "DELETE",
				headers
			});

			const data = await res.json();
			alert(data.message || "ƒê√£ xo√° b√†n!");
			fetchTables();
		} catch (err) {
			alert("L·ªói khi xo√° b√†n!");
			console.error(err);
		}
	}

	function addNewTable() {
		document.getElementById("addRow").classList.remove("hidden");
	}

	async function confirmAddTable() {
		try {
			const name = document.getElementById("newName").value;
			const status = document.getElementById("newStatus").value;
			if (!name) {
				alert("Ph·∫£i nh·∫≠p t√™n b√†n!");
				return;
			}

			const res = await fetch("/api/tables", {
				method: "POST",
				headers,
				body: JSON.stringify({ name, status })
			});

			alert("ƒê√£ th√™m b√†n m·ªõi!");
			cancelAddTable();
			fetchTables();
		} catch (err) {
			alert("L·ªói khi th√™m b√†n!");
			console.error(err);
		}
	}

	function cancelAddTable() {
		document.getElementById("addRow").classList.add("hidden");
		document.getElementById("newName").value = "";
		document.getElementById("newStatus").value = "available";
	}

	fetchTables();
</script>

</body>
</html>
